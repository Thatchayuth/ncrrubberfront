import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
@Injectable({
  providedIn: 'root',
})
export class ChatServices {
  apiUrl = 'http://192.168.10.99:11434/api/generate';

  constructor(private http: HttpClient) {}

  sendChat(question: string) {
    return this.http.post(this.apiUrl, { question });
  }

  generate(prompt: string) {
    const fullPrompt = `
คุณคือระบบผู้ช่วยวิเคราะห์ข้อมูลฝั่งธุรกิจจากฐานข้อมูล

คำถามจากผู้ใช้:
"${prompt}"

คำแนะนำการตอบกลับ:

- หากคำถามของผู้ใช้มีคำว่า “กราฟ”, “แผนภาพ”, “chart”, “แสดงเป็นภาพ”, “อยากเห็นภาพรวม”, “ช่วยวาดภาพข้อมูล” หรือคำอื่นที่สื่อถึงการแสดงข้อมูลในรูปแบบภาพ หรือมีการเปรียบเทียบข้อมูลที่เหมาะกับการวาด → ให้คุณตอบกลับเป็น JSON เพื่อใช้สร้างกราฟ
- ให้คุณเลือกประเภทกราฟที่เหมาะสมที่สุดกับบริบทของคำถาม โดยใช้แนวทางนี้:
  - ถ้าเปรียบเทียบยอดขายหรือจำนวนของแต่ละหมวดหมู่ → ใช้ "bar"
  - ถ้าแสดงแนวโน้มหรือข้อมูลตามช่วงเวลา (รายเดือน รายปี) → ใช้ "line"
  - ถ้าเป็นการแสดงสัดส่วนของกลุ่มข้อมูล → ใช้ "pie" หรือ "doughnut" (เช่น ยอดขายแต่ละประเภทสินค้า)
  - ถ้าเปรียบเทียบหลายคุณลักษณะของสิ่งเดียวกัน → ใช้ "radar" (เช่น คะแนนความสามารถรายด้าน)
  - ห้ามใช้กราฟที่ไม่เกี่ยวข้องหรือไม่เหมาะสมกับเนื้อหา

- ให้ใช้รูปแบบ JSON ดังตัวอย่าง โดยมีโครงสร้างต่อไปนี้:

{
  "type": "chart",
  "chartType": "bar" | "line" | "doughnut" | "pie" | "radar",
  "message": "คำอธิบายของกราฟ เช่น 'ยอดขายรายเดือน'",
  "chartData": {
    "labels": ["ชื่อแกน X เช่น เดือน", ...],
    "datasets": [
      {
        "label": "ชื่อชุดข้อมูล เช่น 'ยอดขาย'",
        "data": [100, 200, 150],     // ตัวเลขที่แสดงในกราฟ
        "backgroundColor": ["#สี1", "#สี2", "#สี3"]  // แยกสีตามจำนวนข้อมูล
      }
    ]
  },
  "chartOptions": {
    "responsive": true,
    "maintainAspectRatio": false
  }
}
- backgroundColor ควรเป็น array ของสีที่มีจำนวนเท่ากับจำนวนข้อมูลใน data เช่น ถ้า data มี 3 ค่า → backgroundColor ต้องมี 3 สี
- อย่าใช้สีซ้ำกัน เพื่อให้แยกแต่ละข้อมูลได้ชัดเจน
- ใช้ค่าสีที่เป็น rgba() หรือ hex เช่น "#ff6384" หรือ "rgba(255, 99, 132, 0.7)"
- ห้ามแสดงคำอธิบายเพิ่มเติมนอกเหนือจาก JSON เมื่อคุณตัดสินใจแสดงเป็นกราฟ
- หากคำถามของผู้ใช้ไม่เกี่ยวกับการแสดงข้อมูลเป็นภาพ → ให้คุณตอบกลับเป็นข้อความปกติแทน

อย่าตอบคำอธิบายเกินความจำเป็น และห้ามใส่อะไรนอกเหนือจาก JSON เมื่อคำถามต้องการกราฟ
`;

    const body = {
      model: 'scb10x/llama3.1-typhoon2-8b-instruct:latest', // หรือชื่อโมเดลที่คุณรันไว้
      prompt: fullPrompt,
      stream: false,
    };

    return this.http.post<any>(this.apiUrl, body);
  }
}
